name: Deploy to Production

on:
  push:
    branches: [ master ]
  workflow_dispatch:

env:
  DOTNET_VERSION: '9.0.x'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
    - uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Configure SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true
        echo "Host ${{ secrets.VPS_HOST }}" >> ~/.ssh/config
        echo "  IdentityFile ~/.ssh/deploy_key" >> ~/.ssh/config
        echo "  StrictHostKeyChecking no" >> ~/.ssh/config

    - name: Build and Test
      run: |
        dotnet restore
        dotnet build --no-restore
        dotnet test --no-build --verbosity normal
                
    - name: Deploy
      run: |
        echo "Deploying to production..."
        rsync -avz --delete \
          --exclude '.git' \
          --exclude 'node_modules' \
          --exclude '*.tar.gz' \
          --exclude 'bin/' \
          --exclude 'obj/' \
          -e "ssh -p ${{ secrets.SSH_PORT }} -i ~/.ssh/deploy_key" \
          ./ unonuso@${{ secrets.VPS_HOST }}:/home/unonuso/nonuso_net/

    - name: Write Secrets to Files on Server
      run: |
        echo "Writing secrets to files on server..."
        SSH_COMMAND="ssh -p ${{ secrets.SSH_PORT }} -i ~/.ssh/deploy_key unonuso@${{ secrets.VPS_HOST }}"
        SECRET_DIR="/home/unonuso/nonuso_net/secrets"
        $SSH_COMMAND "mkdir -p $SECRET_DIR"  
        echo "${{ secrets.DB_CONNECTION }}" > db_connection.txt
        echo "${{ secrets.POSTGRES_PASSWORD }}" > postgres_password.txt
        echo "${{ secrets.REDIS_CONNECTION }}" > redis_connection.txt
        echo "${{ secrets.JWT_SECRET }}" > jwt_secret.txt
        echo "${{ secrets.S3_ACCESS_KEY }}" > s3_access_key.txt
        echo "${{ secrets.S3_SECRET_KEY }}" > s3_secret_key.txt
        echo "${{ secrets.S3_BUCKET_NAME }}" > s3_bucket_name.txt
        echo "${{ secrets.S3_ENDPOINT }}" > s3_endpoint.txt
        echo "${{ secrets.ONESIGNAL_API_KEY }}" > onesignal_api_key.txt
        echo "${{ secrets.ONESIGNAL_APP_ID }}" > onesignal_app_id.txt
        echo "${{ secrets.REDIS_PASSWORD }}" > redis_password.txt  
        rsync -avz -e "ssh -p ${{ secrets.SSH_PORT }} -i ~/.ssh/deploy_key" \
          db_connection.txt \
          postgres_password.txt \
          redis_connection.txt \
          jwt_secret.txt \
          s3_access_key.txt \
          s3_secret_key.txt \
          s3_bucket_name.txt \
          s3_endpoint.txt \
          onesignal_api_key.txt \
          onesignal_app_id.txt \
          redis_password.txt \
          unonuso@${{ secrets.VPS_HOST }}:/home/unonuso/nonuso_net/secrets/  
        rm db_connection.txt \
           postgres_password.txt \
           redis_connection.txt \
           jwt_secret.txt \
           s3_access_key.txt \
           s3_secret_key.txt \
           s3_bucket_name.txt \
           s3_endpoint.txt \
           onesignal_api_key.txt \
           onesignal_app_id.txt \
           redis_password.txt  
        echo "Secrets written and secured on server."

    - name: Start Services
      run: |
        echo "Starting services..."
        ssh -p ${{ secrets.SSH_PORT }} -i ~/.ssh/deploy_key unonuso@${{ secrets.VPS_HOST }} "cd /home/unonuso/nonuso_net && docker compose -f docker-compose.prod.yml up -d --build"

    - name: Run Migrations
      run: |
        echo "Running database migrations..."
        ssh -p ${{ secrets.SSH_PORT }} -i ~/.ssh/deploy_key unonuso@${{ secrets.VPS_HOST }} "cd /home/unonuso/nonuso_net && docker compose -f docker-compose.prod.yml run --rm migration"
