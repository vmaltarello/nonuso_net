name: Deploy to Production

on:
  push:
    branches: [ master ]
  workflow_dispatch:

env:
  DOTNET_VERSION: '9.0.x'
  DOCKER_COMPOSE_VERSION: 'v2.24.5'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
    - uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Setup Docker Compose
      uses: ndeloof/install-compose@v1
      with:
        version: ${{ env.DOCKER_COMPOSE_VERSION }}

    - name: Configure SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true
        echo "Host ${{ secrets.VPS_HOST }}" >> ~/.ssh/config
        echo "  IdentityFile ~/.ssh/deploy_key" >> ~/.ssh/config
        echo "  StrictHostKeyChecking no" >> ~/.ssh/config

    - name: Build and Test
      run: |
        dotnet restore
        dotnet build --no-restore
        dotnet test --no-build --verbosity normal

    - name: Create Backup
      run: |
        echo "Creating backup..."
        ssh -i ~/.ssh/deploy_key ununuso@${{ secrets.VPS_HOST }} "cd /home/ununuso/nonuso_net && docker-compose -f docker-compose.prod.yml down && tar -czf backup_$(date +%Y%m%d_%H%M%S).tar.gz ."

    - name: Deploy
      run: |
        echo "Deploying to production..."
        rsync -avz --delete \
          --exclude '.git' \
          --exclude 'node_modules' \
          --exclude '*.tar.gz' \
          -e "ssh -i ~/.ssh/deploy_key" \
          ./ ununuso@${{ secrets.VPS_HOST }}:/home/ununuso/nonuso_net/

    - name: Start Services
      run: |
        echo "Starting services..."
        ssh -i ~/.ssh/deploy_key ununuso@${{ secrets.VPS_HOST }} "cd /home/ununuso/nonuso_net && docker-compose -f docker-compose.prod.yml up -d"

    - name: Run Migrations
      run: |
        echo "Running database migrations..."
        ssh -i ~/.ssh/deploy_key ununuso@${{ secrets.VPS_HOST }} "cd /home/ununuso/nonuso_net && docker-compose -f docker-compose.prod.yml run --rm migrator"

    - name: Verify Deployment
      run: |
        echo "Verifying deployment..."
        sleep 30  # Wait for services to start
        curl -f https://${{ secrets.VPS_HOST }}:8080/health || exit 1
