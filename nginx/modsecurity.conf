# ModSecurity configuration
SecRuleEngine On
SecRequestBodyAccess On
SecRule REQUEST_HEADERS:Content-Type "text/xml" \
     "id:'200000',phase:1,t:none,t:lowercase,pass,nolog,ctl:requestBodyProcessor=XML"

# Basic rule set
SecRule REQUEST_HEADERS:User-Agent "^$" \
    "id:1000,phase:1,deny,status:403,msg:'Empty User Agent'"

SecRule REQUEST_HEADERS:Content-Length "!^[0-9]+$" \
    "id:1001,phase:1,deny,status:403,msg:'Invalid Content Length'"

# SQL Injection Protection
SecRule ARGS|ARGS_NAMES|REQUEST_COOKIES|REQUEST_COOKIES_NAMES|REQUEST_HEADERS|XML:/* "(?i:(\%27)|(\')|(\-\-)|(\%23)|(#))" \
    "id:1002,phase:2,deny,status:403,msg:'SQL Injection Attack'"

# XSS Protection
SecRule ARGS|ARGS_NAMES|REQUEST_COOKIES|REQUEST_COOKIES_NAMES|REQUEST_HEADERS|XML:/* "(?i:(<script|javascript:|<iframe|<object|data:))" \
    "id:1003,phase:2,deny,status:403,msg:'XSS Attack'"

# Path Traversal Protection
SecRule ARGS|ARGS_NAMES|REQUEST_COOKIES|REQUEST_COOKIES_NAMES|REQUEST_HEADERS|XML:/* "(?i:(\.\.\/|\.\.\\|\.\.\/\.\.|\.\.\\\.\.))" \
    "id:1004,phase:2,deny,status:403,msg:'Path Traversal Attack'"

# Command Injection Protection
SecRule ARGS|ARGS_NAMES|REQUEST_COOKIES|REQUEST_COOKIES_NAMES|REQUEST_HEADERS|XML:/* "(?i:(;|\||`|>|<|&|\\|\/))" \
    "id:1005,phase:2,deny,status:403,msg:'Command Injection Attack'"

# File Upload Protection
SecRule FILES|FILES_NAMES "\.(php|phtml|php3|php4|php5|php7|phar|inc|pl|py|jsp|asp|htm|html|shtml|sh|cgi)$" \
    "id:1006,phase:2,deny,status:403,msg:'Invalid File Upload'"

# Rate Limiting
SecRule &ARGS:username "@gt 0" \
    "id:1007,phase:2,pass,nolog,setvar:user.attempt=+1,expirevar:user.attempt=60"

SecRule &ARGS:username "@gt 0" \
    "id:1008,phase:2,deny,status:429,msg:'Too Many Requests',chain"
SecRule &user.attempt "@gt 5" \
    "t:none"

# Logging
SecAuditEngine On
SecAuditLog /var/log/nginx/modsec_audit.log
SecAuditLogParts ABCFHZ
SecAuditLogType Serial
SecAuditLogStorageDir /var/log/nginx/modsec_audit/ 